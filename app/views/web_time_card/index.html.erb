<style>
input[type=time]::-webkit-clear-button ,
input[type=date]::-webkit-clear-button {
  -webkit-appearance: none;
}
</style>

<script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<script>
  $(window).on('load', function() {
    var config = {
      apiKey: "AIzaSyAMUwIsLui2uoQnARuNOSsu7NDDSCroJV4",
      authDomain: "my-sample-project-ead35.firebaseapp.com",
      databaseURL: "https://my-sample-project-ead35.firebaseio.com",
      projectId: "my-sample-project-ead35",
      storageBucket: "my-sample-project-ead35.appspot.com",
      messagingSenderId: "85638353398"
    };
    firebase.initializeApp(config);

    firebase.auth().onAuthStateChanged(function(user) {
      if(user) {
        toggleEditState(false);
        addMainButton('<%= @worktype %>');

        $('#display_name').html(user.displayName);
      } else {
        var redirect_url = "/login/index" + location.search;
        if(document.referrer) {
          var referrer = "referrer=" + encodeURIComponent(document.referrer);
          redirect_url = redirect_url + (location.search ? '&' : '?') + referrer;
        }
        location.href = redirect_url;
      }
    });

    var isEdit = false;
    var predata = [];

    function handler(e, id) {
      console.log(e);
    }

    function getDate(date) {
      rawDate = new Date(date);
      var year = rawDate.getFullYear();
      var month = (rawDate.getMonth() + 1);
      var day = rawDate.getDate();
      return year + "-" + ("00"+month).substr(-2) + "-" + ("00"+day).substr(-2);
    }

    function getTime(date) {
      rawDate = new Date(date);
      var hour = rawDate.getHours();
      var minutes = rawDate.getMinutes();
      return ("00"+hour).substr(-2) + ":" + ("00"+minutes).substr(-2);
    }

    function postRecord() {
      var token = $('meta[name="csrf-token"]').attr('content');
      $.ajax({
        async: false,
        type : 'POST',
        url  : '/update',
        contentType: 'application/json',
        headers: { 'X-CSRF-TOKEN': token },
        data : JSON.stringify({"data": predata})
      }).done(function(data, textStatus, jqXHR) {
        console.log("done");
      }).fail(function(jqXHR, textStatus, errorThrown) {
        console.log("fail");
      });
    }

    function postDeleteRow(id) {
      var token = $('meta[name="csrf-token"]').attr('content');
      $.ajax({
        async: false,
        type : 'POST',
        url  : '/delete',
        contentType: 'application/json',
        headers: { 'X-CSRF-TOKEN': token },
        data : JSON.stringify({"id": id})
      }).done(function(data, textStatus, jqXHR) {
        console.log("done");
      }).fail(function(jqXHR, textStatus, errorThrown) {
        console.log("fail");
      });
    }

    function addRecord(edit) {
      $.getJSON("/show", null, function(data, status) {
        $("#tbody").empty();
        predata = data;

        if(edit) {
          var tr = $("table thead tr");
          tr.empty();
          tr.append('<th scope="col">月日</th>');
          tr.append('<th scope="col">時刻</th>');
          tr.append('<th scope="col">状況</th>');
          tr.append('<th scope="col">削除</th>');
        } else {
          var tr = $("table thead tr");
          tr.empty();
          tr.append('<th scope="col">月日</th>');
          tr.append('<th scope="col">時刻</th>');
          tr.append('<th scope="col">状況</th>');
        }

        for (i in data) {
          var date_text = "";
          var time_text = "";
          var s_text = "";
          var opt_text = "";
          if(edit) {
            date_text = '<td><input type="date" value="' + getDate(data[i].datetime) + '" rowid=' + i + '></td>';
            time_text = '<td><input type="time" value="' + getTime(data[i].datetime) + '" rowid=' + i + '></td>';
            if(data[i].status == "start") {
              s_text = '<td class="bg-primary text-white text-center">出社</td>';
            } else {
              s_text = '<td class="bg-dark text-white text-center">退社</td>';
            }
            opt_text = '<td class="text-center" id="delrow" rowid='+i+'><i class="fas fa-trash text-danger"></i></td>';
          } else {
            date_text = '<td>' + getDate(data[i].datetime) + '</td>';
            time_text = '<td>' + getTime(data[i].datetime) + '</td>';
            if(data[i].status == "start") {
              s_text = '<td class="bg-primary text-white text-center">出社</td>';
            } else {
              s_text = '<td class="bg-dark text-white text-center">退社</td>';
            }
          }
          $("#tbody").append("<tr>" + date_text + time_text + s_text + opt_text + "</tr>");
        }
      });
    }

    function addMainButton(worktype) {
      var btn = $('<input />');
      btn.attr({
        type: 'submit',
        name: 'commit',
        style: 'font-size: 500%;'
      });

      if(worktype == 'start') {
        btn.attr('class', 'btn btn-primary btn-block');
        btn.attr('value', '出社');
        btn.attr('data-disable-with', '出社');
      } else {
        btn.attr('class', 'btn btn-dark btn-block');
        btn.attr('value', '退社');
        btn.attr('data-disable-with', '退社');
      }

      $('#worktype_form').append(btn);
    }

    function toggleEditState(flag) {
      addRecord(isEdit);

      var o = $("#edit");
      o.empty();
      if(isEdit) {
        isEdit = false;
        o.append("キャンセル");

        $("#alldel").css("visibility", "visible");
        $("#editdone").css("visibility", "visible");
      } else {
        isEdit = true;
        o.append("編集");

        $("#alldel").css("visibility", "hidden");
        $("#editdone").css("visibility", "hidden");
      }
    }

    $('tbody').on('click', 'tr td[id=delrow]', function() {
      var i = $(this).attr('rowid');
      var id = predata[i].id;
      postDeleteRow(id);
      addRecord(true);
    })

    $('#tbody').on('change', 'input[type="date"]', function() {
      var i = $(this).attr('rowid');
      var orig = new Date(predata[i].datetime);
      var mod = new Date($(this).val());
      orig.setFullYear(mod.getFullYear());
      orig.setMonth(mod.getMonth());
      orig.setDate(mod.getDate());
      predata[i].datetime = orig.toJSON();
    });

    $('#tbody').on('change', 'input[type="time"]', function() {
      var i = $(this).attr('rowid');
      var orig = new Date(predata[i].datetime);
      var mod = new Date("2000-01-01T" + $(this).val() + ":00+09:00");
      orig.setHours(mod.getHours());
      orig.setMinutes(mod.getMinutes());
      predata[i].datetime = orig.toJSON();
    });

    $('#editdone').on('click', function() {
      postRecord();

      toggleEditState(isEdit);
    });

    $('#edit').on('click', function() {
      toggleEditState(isEdit);
    });
  });
</script>

<nav class="navbar fixed-bottom navbar-expand-lg navbar-dark bg-dark" style="height:70px">
  <ul class="nav nav-pills nav-fill">
    <li class="nav-item">
      <a class="nav-link active" id="edit" href="javascript:void(0);"></a>
    </li>
  </ul>
  <button id="alldel" type="button" class="btn btn-danger ml-auto" data-toggle="modal" data-target="#myModal" style="visibility:hidden">
    全て削除
  </button>
  <button id="editdone" type="button" class="btn btn-outline-success ml-auto" style="visibility:hidden">
    完了
  </button>
</nav>

<div class=container">
  <div class="row">
    <div class="col-md-4">
      <h4 id='display_name'>Loading...</h4>
      <%= form_with scope: :card, url: "start" , method: :post, local: true, id: 'worktype_form' do |form| %>
        <%= form.hidden_field :status, :value => @worktype %>
      <% end %>

      <table class="table">
        <thead>
          <tr class="text-center"></tr>
        </thead>
        <tbody id="tbody">
        </tbody>
      </table>

      <div class="modal" tabindex="-1" role="dialog" id="myModal">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <p>本当に削除しますか？</p>
            </div>
            <div class="modal-footer">
              <%= button_to "削除", {action: "delete_all"}, {:class => "btn btn-danger"} %>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">しない</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
